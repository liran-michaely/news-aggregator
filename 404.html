<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Topic News Aggregator</title>
    <meta name="theme-color" content="#111827" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="icon" href="./icons/icon-192.png" />
    <style>
      html,body { height: 100%; margin: 0; }
      #root { min-height: 100vh; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
      .source-pill{ display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; border-radius:9999px; background:#0b1220; color:#93c5fd; border:1px solid #1f2937; font-size:12px }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useMemo, useEffect } = React;

      const IL_SITES = [
        "ynet.co.il","walla.co.il","haaretz.co.il","israelhayom.co.il","maariv.co.il","globes.co.il","themarker.com"
      ];

      function heVariants(q){
        const vars = new Set([q]);
        if (q.includes("×¤×™×‘×¨×•××™×œ××’×™×”")) vars.add("×¤×™×‘×¨×•××™××œ×’×™×”");
        vars.add(q.replace(/×™×œ××’×™×”/g, "×™××œ×’×™×”"));
        return Array.from(vars).filter(Boolean);
      }

      function App() {
        const [topic, setTopic] = useState("");
        const [articles, setArticles] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const [sort, setSort] = useState("relevance");
        const [menuOpen, setMenuOpen] = useState(false);
        const [history, setHistory] = useState([]);
        const [selected, setSelected] = useState(new Set());
        const [preview, setPreview] = useState(null);
        const [scanInfo, setScanInfo] = useState({attempted:0, succeeded:0});

        const isHebrewUI = useMemo(() => /[\u0590-\u05FF]/.test(topic), [topic]);

        useEffect(() => {
          const saved = JSON.parse(localStorage.getItem("news_topics_history") || "[]");
          if (Array.isArray(saved)) setHistory(saved);
          const last = localStorage.getItem("news_last_topic");
          if (last) setTopic(last);
          if ("serviceWorker" in navigator) { navigator.serviceWorker.register("./sw.js").catch(()=>{}); }
        }, []);

        useEffect(() => { localStorage.setItem("news_last_topic", topic); }, [topic]);
        useEffect(() => { localStorage.setItem("news_topics_history", JSON.stringify(history)); }, [history]);

        function timeAgo(iso) {
          if (!iso) return "";
          const t = Date.now() - new Date(iso).getTime();
          const m = Math.max(0, Math.floor(t/60000));
          if (m < 1) return isHebrewUI ? "×¢×›×©×™×•" : "just now";
          if (m < 60) return isHebrewUI ? `${m} ×“×§` : `${m}m`;
          const h = Math.floor(m/60);
          if (h < 24) return isHebrewUI ? `${h} ×©×³` : `${h}h`;
          const d = Math.floor(h/24);
          return isHebrewUI ? `${d} ×™××™×` : `${d}d`;
        }

        function truncate(s, n=160) { return !s ? "" : (s.length > n ? s.slice(0,n-1) + "â€¦" : s); }
        const fallbackImgSeed = (title) => `https://picsum.photos/seed/${encodeURIComponent(title||"news")}/900/600`;

        function normalizeAndSort(arr, qForRelevance) {
          const list = [...arr];
          if (sort === "newest") return list.sort((a,b)=> new Date(b.publishedAt||0) - new Date(a.publishedAt||0));
          if (sort === "oldest") return list.sort((a,b)=> new Date(a.publishedAt||0) - new Date(b.publishedAt||0));
          const q = (qForRelevance||"").toLowerCase();
          return list.sort((a,b)=>{
            const inA = (a.title||"").toLowerCase().includes(q)?1:0;
            const inB = (b.title||"").toLowerCase().includes(q)?1:0;
            const tA = new Date(a.publishedAt||0).getTime();
            const tB = new Date(b.publishedAt||0).getTime();
            const sA = a.score||0, sB = b.score||0;
            return (inB*2 + tB/1e13 + sB/1000) - (inA*2 + tA/1e13 + sA/1000);
          });
        }

        function addToHistory(q){ if (!q) return; setHistory(prev=>[q, ...prev.filter(x=>x!==q)].slice(0,50)); }

        function googleNewsRss(q, lang="he", region="IL"){
          return `https://news.google.com/rss/search?q=${encodeURIComponent(q)}&hl=${lang}&gl=${region}&ceid=${region}:${lang}`;
        }
        async function fetchRSS(url){
          const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
          try{
            const r = await fetch(proxy);
            if(!r.ok) throw new Error("fetch failed");
            const j = await r.json();
            const xml = new DOMParser().parseFromString(j.contents || "", "text/xml");
            const items = Array.from(xml.querySelectorAll("item")).map((node, idx)=>{
              const title = node.querySelector("title")?.textContent || "";
              const link = node.querySelector("link")?.textContent || "";
              const pubDate = node.querySelector("pubDate")?.textContent || "";
              const source = node.querySelector("source")?.textContent || "Google News";
              const description = node.querySelector("description")?.textContent || "";
              const imgMatch = description.match(/<img[^>]+src=["']([^"']+)["']/i);
              const image = imgMatch?.[1] || fallbackImgSeed(title);
              return { id:`gn_${idx}_${link}`, title, url:link, source, publishedAt:new Date(pubDate).toISOString(), description: description.replace(/<[^>]+>/g, ''), image, score:0 };
            });
            return items;
          } catch(e){
            return [];
          }
        }

        async function fetchNews(query){
          const q = (query ?? topic).trim();
          if (!q) return;
          setLoading(true); setError(null); setArticles([]);
          setScanInfo({attempted:0, succeeded:0});
          try {
            const isHeb = /[\u0590-\u05FF]/.test(q);
            const variants = isHeb ? heVariants(q) : [q];
            const endpoints = [];
            variants.forEach(v => endpoints.push(googleNewsRss(v, "he", "IL")));
            variants.forEach(v => ["ynet.co.il","walla.co.il","haaretz.co.il","israelhayom.co.il","maariv.co.il","globes.co.il","themarker.com"].forEach(site => endpoints.push(googleNewsRss(`site:${site} ${v}`, "he", "IL"))));
            endpoints.push(googleNewsRss(q, "en", "US"));
            setScanInfo({attempted:endpoints.length, succeeded:0});
            const results = await Promise.all(endpoints.map(fetchRSS));
            const succeeded = results.filter(arr => Array.isArray(arr) && arr.length>0).length;
            setScanInfo({attempted:endpoints.length, succeeded});
            const seen = new Set(); const merged = [];
            for(const arr of results){
              for(const it of arr){
                const key = (it.url||'') + '|' + (it.title||'').toLowerCase();
                if(!seen.has(key)){ seen.add(key); merged.push(it); }
              }
            }
            setArticles(normalizeAndSort(merged, q));
            addToHistory(q);
          } catch (e){ setError(e?.message || 'Failed to fetch'); }
          finally { setLoading(false); }
        }

        function reSearch(q){ setTopic(q); setMenuOpen(false); setSelected(new Set()); fetchNews(q); }
        function toggleSelect(q){ setSelected(prev=>{ const n=new Set(prev); n.has(q)?n.delete(q):n.add(q); return n;}); }
        function deleteSelected(){ if (selected.size===0) return; setHistory(prev=>prev.filter(x=>!selected.has(x))); setSelected(new Set()); }
        function clearAll(){ setHistory([]); setSelected(new Set()); }

        async function openPreview(url, title, source, image){
          setPreview({ url, source, title, image, loading:true });
          try{
            const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            const res = await fetch(proxy);
            if (!res.ok) throw new Error('Proxy fetch failed');
            const data = await res.json();
            const html = String(data.contents||'');
            const doc = new DOMParser().parseFromString(html,'text/html');
            const sel = q => doc.querySelector(q)?.getAttribute('content');
            const text = q => doc.querySelector(q)?.textContent;
            const mTitle = sel('meta[property="og:title"]') || sel('meta[name="twitter:title"]') || text('title') || title;
            const mDesc = sel('meta[property="og:description"]') || sel('meta[name="description"]') || sel('meta[name="twitter:description"]') || text('article p') || '';
            const mImg = sel('meta[property="og:image"]') || sel('meta[name="twitter:image"]') || image;
            setPreview({ url, source, title: mTitle, description: mDesc, image: mImg, loading:false });
          } catch(e){ setPreview({ url, source, title, image, loading:false, error: e?.message || 'Preview failed' }); }
        }
        function closePreview(){ setPreview(null); }

        return (
          <div style={{ minHeight:'100vh', background:'linear-gradient(135deg, #0ea5e9 0%, #7c3aed 50%, #111827 100%)' }} dir={isHebrewUI?'rtl':'ltr'}>
            <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', padding:'12px 16px' }}>
              <button onClick={()=>setMenuOpen(v=>!v)} style={{ border:'1px solid #93c5fd', background:'rgba(17,24,39,0.6)', color:'#e5e7eb', borderRadius:10, padding:'8px 10px', cursor:'pointer' }}>â˜°</button>
              <h1 style={{ margin:0, fontSize:'1.6rem', color:'#fff' }}>{isHebrewUI ? '××’×¨×’×˜×•×¨ ×—×“×©×•×ª ×œ×¤×™ × ×•×©×' : 'Topic News Aggregator'}</h1>
              <div style={{ display:'flex', alignItems:'center', gap:8 }}>
                <label style={{ color:'#e5e7eb', fontSize:12 }}>{isHebrewUI ? '××™×•×Ÿ' : 'Sort'}</label>
                <select value={sort} onChange={e=>setSort(e.target.value)} style={{ padding:'8px 10px', borderRadius:10, border:'1px solid #93c5fd', background:'#1f2937', color:'#f9fafb' }}>
                  <option value="relevance">{isHebrewUI ? '×¨×œ×•×•× ×˜×™×•×ª' : 'Relevance'}</option>
                  <option value="newest">{isHebrewUI ? '×—×“×© ×ª×—×™×œ×”' : 'Newest'}</option>
                  <option value="oldest">{isHebrewUI ? '×™×©×Ÿ ×ª×—×™×œ×”' : 'Oldest'}</option>
                </select>
              </div>
            </div>

            <div style={{ display:'flex', alignItems:'center', gap:8, padding:'0 16px 8px', color:'#e5e7eb', fontSize:13 }}>
              <span class="source-pill">ğŸ” {isHebrewUI ? '××§×•×¨×•×ª ×©× ×¡×¨×§×•' : 'Sources scanned'}: {scanInfo.succeeded}/{scanInfo.attempted}</span>
              <span class="source-pill">ğŸ‡®ğŸ‡± IL: 7 + GNews</span>
              <span class="source-pill">ğŸŒ GNews EN</span>
            </div>

            <aside style={{ position:'fixed', top:0, bottom:0, [isHebrewUI ? 'right' : 'left']:0, width: menuOpen ? 300 : 0, overflow:'hidden', background:'#0b1220', color:'#e5e7eb', borderLeft: isHebrewUI ? '1px solid #1f2937' : 'none', borderRight: !isHebrewUI ? '1px solid #1f2937' : 'none', transition:'width .2s ease', zIndex:50 }}>
              <div style={{ padding:12, display:'flex', alignItems:'center', justifyContent:'space-between' }}>
                <strong>{isHebrewUI ? '×”×™×¡×˜×•×¨×™×™×ª ×—×™×¤×•×©×™×' : 'Search history'}</strong>
                <button onClick={()=>setMenuOpen(false)} style={{ border:'1px solid #374151', background:'transparent', color:'#e5e7eb', borderRadius:8, padding:'4px 8px', cursor:'pointer' }}>âœ•</button>
              </div>
              <div style={{ padding:'0 12px 12px', display:'flex', gap:8 }}>
                <button onClick={deleteSelected} style={{ border:'1px solid #ef4444', background:'transparent', color:'#fecaca', borderRadius:8, padding:'6px 10px', cursor:'pointer' }}>{isHebrewUI ? '××—×§ × ×‘×—×¨×™×' : 'Delete selected'}</button>
                <button onClick={clearAll} style={{ border:'1px solid #93c5fd', background:'transparent', color:'#93c5fd', borderRadius:8, padding:'6px 10px', cursor:'pointer' }}>{isHebrewUI ? '× ×§×” ×”×›×œ' : 'Clear all'}</button>
              </div>
              <div style={{ padding:'0 8px 12px', overflowY:'auto', height:'calc(100% - 100px)' }}>
                {history.length === 0 && <div style={{ padding:12, color:'#94a3b8' }}>{isHebrewUI ? '××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×¢×“×™×™×Ÿ' : 'No history yet'}</div>}
                {history.map(q => (
                  <div key={q} style={{ display:'flex', alignItems:'center', gap:8, padding:'6px 6px', borderBottom:'1px solid #1f2937' }}>
                    <input type="checkbox" checked={selected.has(q)} onChange={()=>toggleSelect(q)} />
                    <button onClick={()=>reSearch(q)} style={{ textAlign:'start', flex:1, background:'transparent', border:0, color:'#e5e7eb', cursor:'pointer' }}>{q}</button>
                  </div>
                ))}
              </div>
            </aside>

            <main style={{ padding:16, marginInlineStart: menuOpen && !isHebrewUI ? 320 : 0, marginInlineEnd: menuOpen && isHebrewUI ? 320 : 0, transition:'margin .2s ease' }}>
              <div style={{ display:'flex', gap:8, marginBottom:12, flexWrap:'wrap' }}>
                <input
                  placeholder={isHebrewUI ? '×”×§×œ×“ × ×•×©×â€¦' : 'Enter a topicâ€¦'}
                  value={topic}
                  onChange={e=>setTopic(e.target.value)}
                  onKeyDown={e=>{ if (e.key==='Enter') fetchNews(topic); }}
                  style={{ flex:1, padding:'12px 14px', borderRadius:14, border:'1px solid #93c5fd', minWidth:240, fontSize:'1rem', background:'rgba(255,255,255,0.95)' }}
                />
                <button onClick={()=>fetchNews(topic)} disabled={loading || !topic.trim()} style={{ padding:'12px 16px', borderRadius:14, background:'linear-gradient(135deg, #22c55e, #06b6d4)', color:'#fff', border:'none', fontWeight:700, cursor:'pointer' }}>{loading ? (isHebrewUI ? '×˜×•×¢×Ÿâ€¦' : 'Loadingâ€¦') : (isHebrewUI ? '×—×¤×©' : 'Search')}</button>
                <button onClick={()=>{ setTopic(''); setArticles([]); setError(null); }} style={{ padding:'12px 16px', borderRadius:14, background:'rgba(17,24,39,0.6)', color:'#e5e7eb', border:'1px solid #93c5fd', cursor:'pointer' }}>{isHebrewUI ? '× ×§×”' : 'Clear'}</button>
              </div>

              {error && <div style={{ background:'rgba(239,68,68,0.15)', color:'#fecaca', border:'1px solid #ef4444', padding:12, borderRadius:12, marginBottom:12 }}>Error: {error}</div>}

              {!loading && articles.length === 0 && !error && (
                <div style={{ background:'rgba(255,255,255,0.98)', border:'1px solid #e5e7eb', borderRadius:18, padding:20, textAlign:'center' }}>
                  <p style={{ color:'#6b7280' }}>{isHebrewUI ? '×—×¤×© × ×•×©× ×›×“×™ ×œ×¨××•×ª ×ª×•×¦××•×ª.' : 'Search for a topic to see results.'}</p>
                </div>
              )}

              {!loading && articles.length > 0 && (
                <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(280px, 1fr))', gap:16 }}>
                  {articles.map(a => (
                    <article key={a.id || a.url} style={{ borderRadius:22, overflow:'hidden', boxShadow:'0 10px 24px rgba(0,0,0,0.25)', background:'rgba(255,255,255,0.98)' }}>
                      <button onClick={()=>openPreview(a.url, a.title, a.source, a.image)} style={{ display:'block', width:'100%', background:'transparent', border:0, padding:0, cursor:'pointer' }}>
                        {a.image && <img src={a.image} alt="" style={{ width:'100%', height:180, objectFit:'cover' }} />}
                        <div style={{ padding:12 }}>
                          <div style={{ display:'flex', justifyContent:'space-between', fontSize:12, color:'#64748b', marginBottom:6 }}>
                            <span style={{ background:'#eef2ff', color:'#3730a3', borderRadius:999, padding:'2px 8px', fontWeight:600 }}>{a.source}</span>
                            <span>{timeAgo(a.publishedAt)}</span>
                          </div>
                          <h3 style={{ fontSize:18, margin:'2px 0 6px', color:'#111827' }}>{a.title}</h3>
                          {a.description && <p style={{ fontSize:14, color:'#374151', margin:0 }}>{truncate(a.description)}</p>}
                        </div>
                      </button>
                    </article>
                  ))}
                </div>
              )}
            </main>

            {preview && (
              <div style={{ position:'fixed', inset:0, background:'rgba(0,0,0,0.55)', display:'grid', placeItems:'center', zIndex:1000 }} onClick={closePreview}>
                <div style={{ width:'92vw', maxWidth:900, background:'#0b1220', borderRadius:16, overflow:'hidden', boxShadow:'0 20px 60px rgba(0,0,0,0.5)' }} onClick={e=>e.stopPropagation()}>
                  <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', padding:'10px 14px', background:'#111827', color:'#e5e7eb', borderBottom:'1px solid #1f2937' }}>
                    <strong style={{ fontSize:14, opacity:.9 }}>{preview.source}</strong>
                    <button onClick={closePreview} style={{ border:'1px solid #374151', background:'transparent', color:'#e5e7eb', borderRadius:8, padding:'6px 10px', cursor:'pointer' }}>âœ•</button>
                  </div>
                  {preview.image && <img src={preview.image} alt="" style={{ width:'100%', maxHeight:360, objectFit:'cover' }} />}
                  <div style={{ padding:16, color:'#e5e7eb' }}>
                    <h2 style={{ margin:'0 0 8px' }}>{preview.title}</h2>
                    {preview.loading && <p style={{ opacity:.8 }}>{isHebrewUI ? '×˜×•×¢×Ÿ ×ª×¦×•×’×” ××§×“×™××”â€¦' : 'Loading previewâ€¦'}</p>}
                    {!preview.loading && preview.description && <p style={{ opacity:.9 }}>{preview.description}</p>}
                    {!preview.loading && preview.error && <p style={{ opacity:.8 }}>{preview.error}</p>}
                    <div style={{ display:'flex', gap:8, marginTop:12, flexWrap:'wrap' }}>
                      <a href={preview.url} target="_blank" rel="noopener noreferrer" style={{ textDecoration:'none', padding:'10px 12px', borderRadius:10, background:'#2563eb', color:'#fff' }}>{isHebrewUI ? '×¤×ª×— ××§×•×¨' : 'Read on site'}</a>
                      <button onClick={()=>navigator.clipboard.writeText(preview.url)} style={{ padding:'10px 12px', borderRadius:10, border:'1px solid #374151', background:'transparent', color:'#e5e7eb', cursor:'pointer' }}>{isHebrewUI ? '×”×¢×ª×§ ×§×™×©×•×¨' : 'Copy link'}</button>
                      {"share" in navigator ? (<button onClick={()=>navigator.share({ title: preview.title, url: preview.url })} style={{ padding:'10px 12px', borderRadius:10, border:'1px solid #374151', background:'transparent', color:'#e5e7eb', cursor:'pointer' }}>{isHebrewUI ? '×©×ª×£' : 'Share'}</button>) : null}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
    <script>
      // Mobile error surface to avoid silent white screens
      window.addEventListener('error', function(e){
        const el = document.createElement('div');
        el.style = 'position:fixed;bottom:0;left:0;right:0;background:#111827;color:#fecaca;font:12px/1.4 system-ui;padding:8px;z-index:9999;border-top:1px solid #ef4444';
        el.textContent = 'Error: ' + (e && e.message ? e.message : 'unknown');
        document.body.appendChild(el);
      });
    </script>
  </body>
</html>
