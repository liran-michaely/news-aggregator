<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Topic News Aggregator</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <aside id="drawer">
    <div class="side">
      <header><div class="wrap"><div class="row" style="justify-content:space-between"><strong>Menu</strong><button id="closeDrawer" class="btn secondary">Close</button></div></div></header>
      <div class="wrap section">
        <h3>Sources</h3>
        <div id="sources" class="list"></div>
      </div>
      <div class="wrap section">
        <h3>History</h3>
        <div id="history" class="list"></div>
        <div class="row"><button id="clearHistory" class="btn secondary">Clear</button></div>
      </div>
      <div class="footer">PWA ready • Works on mobile & desktop</div>
    </div>
  </aside>

  <div class="layout">
    <header>
      <div class="wrap">
        <div class="topbar">
          <button id="openDrawer" class="fab" aria-label="Open menu">☰</button>
          <div class="title" id="title">Topic News Aggregator</div>
          <div class="controls">
            <label id="sortLabel" for="sort">Sort</label>
            <select id="sort" class="select">
              <option value="relevance">Relevance</option>
              <option value="source">Source</option>
              <option value="title">Title</option>
            </select>
          </div>
        </div>

        <div class="badges" id="badges">
          <span class="badge" id="scanBadge">Sources scanned: 0/0</span>
          <span class="badge">IL: 7 + GNews</span>
          <span class="badge">GNews EN</span>
        </div>

        <div class="searchbar">
          <input id="q" class="input" placeholder="Enter a topic..." />
          <button id="go" class="btn">Search</button>
          <button id="clear" class="btn secondary">Clear</button>
        </div>

        <div class="panel" id="panel">
          <div class="placeholder" id="placeholder">Search for a topic to see results.</div>
          <section id="results" class="grid" aria-live="polite" style="display:none"></section>
        </div>
      </div>
    </header>
  </div>

  <div class="modal" id="modal">
    <div class="box">
      <div class="row" style="justify-content:space-between">
        <h3 id="mTitle"></h3>
        <button id="mClose" class="btn secondary">Close</button>
      </div>
      <div class="meta" id="mMeta"></div>
      <p id="mSnippet"></p>
      <p><a id="mLink" target="_blank" rel="noopener" class="btn">Open article</a></p>
    </div>
  </div>

  <script>
    // SW
    try{ if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js'); }catch{}

    // Sources (expanded)
    const SOURCES = [
      { name: "Google News (IL)", host: "news.google.com", type: "search", lang: "he-IL" },
      { name: "Ynet", host: "ynet.co.il", type: "site" },
      { name: "Walla", host: "walla.co.il", type: "site" },
      { name: "N12 (mako)", host: "mako.co.il", type: "site" },
      { name: "KAN", host: "kan.org.il", type: "site" },
      { name: "Maariv", host: "maariv.co.il", type: "site" },
      { name: "Calcalist", host: "calcalist.co.il", type: "site" },
      { name: "TheMarker", host: "themarker.com", type: "site" },
      { name: "Globes", host: "globes.co.il", type: "site" },
      { name: "Jerusalem Post", host: "jpost.com", type: "site" },
      { name: "Times of Israel", host: "timesofisrael.com", type: "site" },
      { name: "Israel Hayom", host: "israelhayom.co.il", type: "site" },
      { name: "i24NEWS", host: "i24news.tv", type: "site" }
    ];

    const $ = (s, el=document)=>el.querySelector(s);
    const create = (t, props={}) => Object.assign(document.createElement(t), props);

    const histKey="newsagg.hist.v3";
    const srcKey="newsagg.src.v3";
    let selectedHosts = new Set(JSON.parse(localStorage.getItem(srcKey) || "null") || SOURCES.map(s=>s.host));

    // Language auto-switch
    function hasHebrew(str){ return /[\u0590-\u05FF]/.test(str); }
    function setLang(isHe){
      document.documentElement.lang = isHe ? 'he' : 'en';
      document.documentElement.dir  = isHe ? 'rtl' : 'ltr';
      $("#title").textContent = isHe ? "אגרגטור חדשות" : "Topic News Aggregator";
      $("#sortLabel").textContent = isHe ? "מיון" : "Sort";
      $("#q").placeholder = isHe ? "הכנס נושא…" : "Enter a topic...";
      $("#go").textContent = isHe ? "חיפוש" : "Search";
      $("#clear").textContent = isHe ? "נקה" : "Clear";
      $("#placeholder").textContent = isHe ? "חפש נושא כדי לראות תוצאות." : "Search for a topic to see results.";
      $("#mClose").textContent = isHe ? "סגור" : "Close";
      $("#mLink").textContent = isHe ? "פתח כתבה" : "Open article";
      // sort options
      const sort = $("#sort");
      sort.options[0].text = isHe ? "רלוונטיות" : "Relevance";
      sort.options[1].text = isHe ? "לפי מקור" : "Source";
      sort.options[2].text = isHe ? "לפי כותרת" : "Title";
      $("#openDrawer").ariaLabel = isHe ? "פתח תפריט" : "Open menu";
      $("#closeDrawer").textContent = isHe ? "סגור" : "Close";
      $("#scanBadge").textContent = isHe ? "מקורות נסרקו: 0/0" : "Sources scanned: 0/0";
    }

    function renderSources(){
      const wrap = $("#sources"); wrap.innerHTML="";
      SOURCES.forEach(s=>{
        const lab = create("div",{className:"checkbox"});
        const cb = create("input",{type:"checkbox", checked: selectedHosts.has(s.host)});
        cb.onchange = ()=>{ if(cb.checked) selectedHosts.add(s.host); else selectedHosts.delete(s.host); localStorage.setItem(srcKey, JSON.stringify([...selectedHosts])); };
        lab.append(cb, create("span",{textContent:s.name}));
        wrap.appendChild(lab);
      });
    }

    function renderHistory(){
      const box = $("#history"); box.innerHTML="";
      const arr = JSON.parse(localStorage.getItem(histKey) || "[]");
      arr.forEach(q=>{
        const row = create("div",{className:"item"});
        const link = create("a",{href:"#",textContent:q});
        link.onclick = (e)=>{ e.preventDefault(); $("#q").value=q; run(q); };
        const del = create("button",{className:"btn secondary",textContent: document.documentElement.lang==='he' ? "מחק" : "Del"});
        del.onclick = ()=>{
          const now = JSON.parse(localStorage.getItem(histKey)||"[]").filter(x=>x!==q);
          localStorage.setItem(histKey, JSON.stringify(now)); renderHistory();
        };
        row.append(link, del); box.appendChild(row);
      });
    }

    function addHistory(q){
      const arr = JSON.parse(localStorage.getItem(histKey) || "[]");
      if(!arr.includes(q)) arr.unshift(q);
      localStorage.setItem(histKey, JSON.stringify(arr.slice(0,30)));
      renderHistory();
    }

    function buildSearchUrl(source, q){
      const encoded = encodeURIComponent(q);
      if (source.type==='search' && source.host==='news.google.com') {
        return `https://news.google.com/search?q=${encoded}&hl=he-IL&gl=IL&ceid=IL:he`;
      }
      return `https://www.bing.com/search?q=site%3A${encodeURIComponent(source.host)}+${encoded}`;
    }

    async function fetchReader(url){
      const base = "https://r.jina.ai/http/";
      const u = url.startsWith("http")? url : ("https://" + url);
      const final = base + u.replace(/^https?:\/\//,"");
      const res = await fetch(final);
      if(!res.ok) throw new Error("Fetch failed: "+res.status);
      return await res.text();
    }

    function parseBing(html, host){
      const out = [];
      const rx = /<li class=\"b_algo\">[\s\S]*?<h2><a href=\"([^\"]+)\"[^>]*>([\s\S]*?)<\/a><\/h2>[\s\S]*?(?:<p>([\s\S]*?)<\/p>)?/g;
      let m; while((m=rx.exec(html))){
        const href = m[1]; if(!href || !href.includes(host)) continue;
        const title = (m[2]||"").replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim();
        const snippet = (m[3]||"").replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim();
        out.push({href, title, snippet, host});
      }
      return out;
    }

    async function findImageFor(url){
      try{
        const html = await fetchReader(url);
        const og = /<meta[^>]+property=\"og:image\"[^>]+content=\"([^\"]+)\"/i.exec(html);
        const tw = /<meta[^>]+name=\"twitter:image\"[^>]+content=\"([^\"]+)\"/i.exec(html);
        return (og && og[1]) || (tw && tw[1]) || "";
      }catch{ return ""; }
    }

    function updateScanBadge(done, total){
      const isHe = document.documentElement.lang==='he';
      $("#scanBadge").textContent = (isHe? "מקורות נסרקו: " : "Sources scanned: ") + done + "/" + total;
    }

    function renderCards(items){
      const grid = $("#results"); grid.innerHTML="";
      items.forEach(it=>{
        const card = create("article",{className:"card"});
        const img = create("img",{alt:""});
        img.src = it.image || "";
        const box = create("div",{className:"box"});
        const h3 = create("h3"); h3.textContent = it.title || it.href;
        const meta = create("div",{className:"meta"}); meta.textContent = new URL(it.href).host;
        const p = create("p"); p.textContent = it.snippet || "";
        const open = create("a",{href:it.href,target:"_blank",rel:"noopener",className:"btn"});
        open.textContent = document.documentElement.lang==='he' ? "פתח מקור" : "Open";
        card.append(img, box);
        box.append(h3, meta, p, open);
        card.onclick = (e)=>{
          if (e.target.tagName.toLowerCase()==='a') return;
          $("#mTitle").textContent = it.title || "";
          $("#mMeta").textContent = new URL(it.href).host;
          $("#mSnippet").textContent = it.snippet || "";
          $("#mLink").href = it.href;
          $("#modal").classList.add("open");
        };
        grid.appendChild(card);
      });
    }

    function sortItems(items, how){
      if(how==='source') items.sort((a,b)=> a.host.localeCompare(b.host));
      if(how==='title') items.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
      return items;
    }

    async function run(q){
      const isHe = hasHebrew(q); setLang(isHe);
      $("#results").style.display = "grid";
      $("#placeholder").style.display = "none";
      const total = SOURCES.filter(s=>selectedHosts.has(s.host)).length;
      let done = 0; updateScanBadge(done,total);
      const all = [];
      for (const src of SOURCES){
        if(!selectedHosts.has(src.host)) continue;
        try{
          const url = buildSearchUrl(src, q);
          if(src.host==="news.google.com"){
            all.push({href:url, title: (isHe? "תוצאות ב-Google News: " : "Google News results for: ") + q, snippet:isHe? "פתח להצגת סיקור רחב":"Open to view aggregated coverage", host: src.host, image:""});
          } else {
            const html = await fetchReader(url);
            let items = parseBing(html, src.host).slice(0,6);
            // Fetch preview images in sequence per source to avoid hammering
            for (let it of items){
              it.image = await findImageFor(it.href);
            }
            all.push(...items);
          }
        }catch(e){
          all.push({href: buildSearchUrl(src,q), title: `[${src.name}] ${isHe? "פתיחת תוצאות (חסימה)":"Open results (blocked)"}`, snippet: String(e.message||e), host: src.host, image:""});
        } finally {
          done++; updateScanBadge(done,total);
        }
      }
      // dedupe
      const seen = new Set(); const uniq=[];
      for(const it of all){ if(!seen.has(it.href)){ seen.add(it.href); uniq.push(it); } }
      renderCards(sortItems(uniq, $("#sort").value));
      addHistory(q);
      history.replaceState(null,"","#q="+encodeURIComponent(q));
    }

    // Wiring
    setLang(false);
    renderSources(); renderHistory();
    $("#go").onclick = ()=>{ const v=$("#q").value.trim(); if(v) run(v); };
    $("#clear").onclick = ()=>{ $("#q").value=""; $("#results").style.display="none"; $("#placeholder").style.display="block"; updateScanBadge(0,0); };
    $("#q").addEventListener("keydown", e=>{ if(e.key==="Enter"){ const v=$("#q").value.trim(); if(v) run(v); }});
    $("#sort").onchange = ()=>{
      const hash = location.hash.startsWith("#q=") ? decodeURIComponent(location.hash.slice(3)) : "";
      if(hash){
        // Re-sort current items by re-running (keeps it simple and consistent)
        run(hash);
      }
    };
    $("#openDrawer").onclick = ()=> $("#drawer").classList.add("open");
    $("#closeDrawer").onclick = ()=> $("#drawer").classList.remove("open");
    $("#clearHistory").onclick = ()=>{ localStorage.removeItem(histKey); renderHistory(); };

    // Deep link
    if (location.hash.startsWith("#q=")){
      const q = decodeURIComponent(location.hash.slice(3));
      $("#q").value = q; run(q);
    }

    // ESC closes modal
    $("#mClose").onclick = ()=> $("#modal").classList.remove("open");
    document.addEventListener("keydown", e=>{ if(e.key==="Escape") $("#modal").classList.remove("open"); });
  </script>
</body>
</html>
