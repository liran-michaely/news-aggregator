<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Topic News Aggregator</title>
    <meta name="theme-color" content="#111827" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="icon" href="./icons/icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
      :root {
        --bg: #0b1220;
        --card: #111827;
        --muted: #9ca3af;
        --text: #e5e7eb;
        --accent: #60a5fa;
        --chip: #1f2937;
      }
      * { box-sizing: border-box; }
      html,body { height: 100%; background: var(--bg); color: var(--text); margin: 0; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
      a { color: var(--accent); text-decoration: none; }
      a:hover { text-decoration: underline; }
      #app { min-height: 100vh; display: grid; grid-template-rows: auto 1fr; }
      header {
        position: sticky; top: env(safe-area-inset-top); z-index: 10;
        background: linear-gradient(180deg, rgba(11,18,32,0.95), rgba(11,18,32,0.75));
        backdrop-filter: saturate(140%) blur(6px);
        border-bottom: 1px solid #1f2937;
      }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 12px 16px; }
      h1 { font-size: clamp(18px, 2.6vw, 24px); margin: 0; letter-spacing: 0.5px; }
      .searchbar {
        display: grid; grid-template-columns: 1fr auto; gap: 8px; margin-top: 10px;
      }
      .searchbar input {
        width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #1f2937; background: #0d1727; color: var(--text);
      }
      .searchbar button {
        padding: 12px 16px; border-radius: 12px; border: 1px solid #1f2937; background: #172033; color: #dbeafe; font-weight: 600;
      }
      .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
      .chip {
        display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
        background: var(--chip); color:#93c5fd; border:1px solid #1f2937; font-size:12px
      }
      .grid {
        display: grid; gap: 12px; padding: 16px;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }
      .card {
        background: var(--card); border:1px solid #1f2937; border-radius: 16px; padding: 14px;
        display: flex; flex-direction: column; gap: 10px;
      }
      .card h3 { margin: 0; font-size: 16px; line-height: 1.2; }
      .card .meta { color: var(--muted); font-size: 12px; }
      footer { text-align:center; color: var(--muted); font-size: 12px; padding: 20px 0; }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  </head>
  <body>
    <div id="app">
      <header>
        <div class="wrap">
          <h1>Topic News Aggregator</h1>
          <div class="searchbar">
            <input id="q" placeholder="Search any topic — works on desktop & mobile" autocomplete="on" />
            <button id="go">Search</button>
          </div>
          <div id="chips" class="chips"></div>
        </div>
      </header>
      <main class="wrap">
        <div id="count" style="margin:10px 0; color: var(--muted);"></div>
        <section id="results" class="grid" aria-live="polite"></section>
      </main>
      <footer>Built for GitHub Pages & Vercel · PWA ready</footer>
    </div>

    <script>
      // Register SW (safe)
      try {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('./sw.js').catch(()=>{});
        }
      } catch(_) {}

      // Sources (can be edited). We'll query Bing HTML via a CORS-friendly reader and filter to each site.
      const SOURCES = [
        { name: "Google News (IL)", host: "news.google.com", type: "search", lang: "he-IL" },
        { name: "Ynet", host: "ynet.co.il", type: "site" },
        { name: "Walla", host: "walla.co.il", type: "site" },
        { name: "Haaretz", host: "haaretz.co.il", type: "site" },
        { name: "Israel Hayom", host: "israelhayom.co.il", type: "site" },
        { name: "Globes", host: "globes.co.il", type: "site" },
        { name: "TheMarker", host: "themarker.com", type: "site" },
      ];

      // Helpers
      const $ = (s, el=document) => el.querySelector(s);
      const create = (t, props={}) => Object.assign(document.createElement(t), props);

      function sanitizeUrl(u){
        try { return new URL(u).href; } catch { return ""; }
      }

      function strip(u){ return (u||"").replace(/\s+/g,' ').trim(); }

      function buildSearchUrl(source, q){
        const encoded = encodeURIComponent(q);
        if (source.type === "search" && source.host === "news.google.com") {
          // Google News search page (we display link only; not parsing due to dynamic content)
          return `https://news.google.com/search?q=${encoded}&hl=he-IL&gl=IL&ceid=IL:he`;
        }
        // Use Bing to search within a site, then we will filter the results for that host.
        return `https://www.bing.com/search?q=site%3A${encodeURIComponent(source.host)}+${encoded}`;
      }

      async function fetchThroughReader(url){
        // Fetch via r.jina.ai to avoid CORS (HTML as text)
        const reader = "https://r.jina.ai/http/";
        const u = url.startsWith("http") ? url : ("https://" + url);
        const final = reader + u.replace(/^https?:\/\//,"");
        const res = await fetch(final, { mode: "cors" });
        if (!res.ok) throw new Error("Fetch failed: " + res.status);
        return await res.text();
      }

      function parseBingLinks(html, host){
        // Very simple extraction from Bing result snippets
        const out = [];
        const rx = /<li class=\"b_algo\">[\s\S]*?<h2><a href=\"([^\"]+)\"[^>]*>([\s\S]*?)<\/a><\/h2>[\s\S]*?<p>([\s\S]*?)<\/p>/g;
        let m;
        while ((m = rx.exec(html))) {
          const href = sanitizeUrl(m[1]);
          if (!href || !href.includes(host)) continue;
          const title = strip(m[2].replace(/<[^>]+>/g, ""));
          const snippet = strip((m[3]||"").replace(/<[^>]+>/g, ""));
          out.push({ href, title, snippet, host });
        }
        return out;
      }

      function renderChips(sources){
        const wrap = $("#chips"); wrap.innerHTML = "";
        sources.forEach(s => {
          const el = create("span", { className: "chip" });
          el.textContent = s.name || s.host;
          wrap.appendChild(el);
        });
      }

      function renderResults(items){
        const grid = $("#results"); grid.innerHTML = "";
        $("#count").textContent = items.length ? (items.length + " results") : "";
        items.forEach(it => {
          const card = create("article", { className: "card" });
          const h3 = create("h3"); h3.textContent = it.title || it.href;
          const meta = create("div", { className: "meta" }); meta.textContent = it.host;
          const p = create("p"); p.textContent = it.snippet || "";
          const a = create("a", { href: it.href, target: "_blank", rel: "noopener" }); a.textContent = "Open";
          card.append(h3, meta, p, a);
          grid.appendChild(card);
        });
      }

      async function run(q){
        renderResults([]);
        $("#count").textContent = "Searching…";
        const all = [];
        for (const src of SOURCES) {
          try {
            const url = buildSearchUrl(src, q);
            if (src.host === "news.google.com") {
              // Just provide the search link card
              all.push({ href: url, title: "Google News results for: " + q, snippet: "Open to view aggregated coverage", host: src.host });
              continue;
            }
            const html = await fetchThroughReader(url);
            const items = parseBingLinks(html, src.host);
            all.push(...items.slice(0, 6)); // limit per source
          } catch (e) {
            all.push({ href: buildSearchUrl(src, q), title: `[${src.name}] Open results (fetch blocked)`, snippet: e.message, host: src.host });
          }
        }
        // Deduplicate by href
        const seen = new Set(); const uniq = [];
        for (const it of all) { if (!seen.has(it.href)) { seen.add(it.href); uniq.push(it); } }
        renderResults(uniq);
      }

      // Wire UI
      renderChips(SOURCES);
      const input = $("#q"); const btn = $("#go");
      function handle(){ const q = input.value.trim(); if (q) { run(q); if (location) { history.replaceState(null, "", "#q=" + encodeURIComponent(q)); } } }
      btn.addEventListener("click", handle);
      input.addEventListener("keydown", (e)=>{ if (e.key === "Enter") handle(); });

      // Deep link via hash
      if (location.hash.startsWith("#q=")) {
        const q = decodeURIComponent(location.hash.slice(3));
        input.value = q; run(q);
      }

      // iOS Safari safe-area padding for bottom UI if needed
      document.body.style.paddingBottom = "env(safe-area-inset-bottom)";
    </script>
  </body>
</html>
