<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>אגרגטור חדשות | Topic News Aggregator</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --chip:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .app{min-height:100vh;display:grid;grid-template-columns:280px 1fr}
    @media (max-width: 900px){ .app{grid-template-columns:1fr} aside{position:fixed;inset:auto 0 0 0;transform:translateY(100%);transition:transform .25s} aside.open{transform:translateY(0)} }
    header{position:sticky;top:env(safe-area-inset-top);z-index:5;background:rgba(11,18,32,.9);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
    h1{margin:0;font-size:clamp(18px,2.5vw,24px)}
    .layout{display:grid;grid-template-rows:auto 1fr}
    .search{display:grid;grid-template-columns:1fr auto auto;gap:8px;margin-top:10px}
    .search input{padding:12px 14px;border:1px solid #1f2937;border-radius:12px;background:#0d1727;color:var(--text)}
    .search button{padding:12px 14px;border:1px solid #1f2937;border-radius:12px;background:#172033;color:#dbeafe;font-weight:600}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{background:var(--chip);color:#93c5fd;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;font-size:12px}
    main{min-height:0}
    .grid{display:grid;gap:12px;padding:16px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .card h3{margin:0;font-size:16px;line-height:1.3}
    .meta{font-size:12px;color:var(--muted)}
    aside{background:var(--panel);border-left:1px solid #1f2937;padding:12px;display:flex;flex-direction:column;gap:10px}
    aside h2{margin:6px 0 0 0;font-size:16px}
    .history{display:flex;flex-direction:column;gap:6px;max-height:40vh;overflow:auto}
    .hist-item{display:flex;justify-content:space-between;gap:10px;background:#0d1727;border:1px solid #1f2937;border-radius:10px;padding:8px 10px}
    .controls{display:flex;gap:8px;align-items:center}
    .toggle-aside{display:none}
    @media (max-width: 900px){ .toggle-aside{display:inline-flex} }
    .count{color:var(--muted);padding-inline:16px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}
    .modal .box{max-width:900px;width:100%;background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px;overflow:auto;max-height:80vh}
    .box h3{margin:0 0 10px 0}
    .row{display:flex;gap:8px;align-items:center}
    .select{padding:10px;border:1px solid #1f2937;border-radius:10px;background:#0d1727;color:var(--text)}
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <div class="wrap">
        <h1>אגרגטור חדשות</h1>
        <div class="search">
          <input id="q" placeholder="חפש כל נושא (נייד/דסקטופ)" />
          <button id="go">חיפוש</button>
          <button id="toggle" class="toggle-aside">היסטוריה</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="chips" id="chips"></div>
          <select id="sort" class="select" title="סידור">
            <option value="default">ברירת מחדל</option>
            <option value="source">לפי מקור</option>
            <option value="title">לפי כותרת</option>
          </select>
        </div>
      </div>
    </header>
    <div class="app">
      <aside id="aside">
        <h2>היסטוריית חיפושים</h2>
        <div class="history" id="history"></div>
        <div class="controls">
          <button id="clear">נקה</button>
          <a id="share" href="#">שתף</a>
        </div>
        <h2>מקורות</h2>
        <div id="sources"></div>
      </aside>
      <main>
        <div class="count" id="count"></div>
        <section id="results" class="grid" aria-live="polite"></section>
      </main>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="box">
      <div class="row" style="justify-content:space-between">
        <h3 id="m-title"></h3>
        <button id="m-close">סגור</button>
      </div>
      <div class="meta" id="m-meta"></div>
      <p id="m-snippet"></p>
      <p><a id="m-link" target="_blank" rel="noopener">פתח כתבה</a></p>
    </div>
  </div>

  <script>
    // Service worker register (safe)
    try{ if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); } }catch(e){}

    // Expanded sources (v10+ and more free Israeli outlets)
    const SOURCES = [
      { name: "Google News (IL)", host: "news.google.com", type: "search", lang: "he-IL" },
      { name: "Ynet", host: "ynet.co.il", type: "site" },
      { name: "Walla", host: "walla.co.il", type: "site" },
      { name: "N12", host: "mako.co.il", type: "site" },
      { name: "Kan News", host: "kan.org.il", type: "site" },
      { name: "Maariv", host: "maariv.co.il", type: "site" },
      { name: "Calcalist", host: "calcalist.co.il", type: "site" },
      { name: "TheMarker", host: "themarker.com", type: "site" },
      { name: "Globes", host: "globes.co.il", type: "site" },
      { name: "Jerusalem Post", host: "jpost.com", type: "site" },
      { name: "Times of Israel", host: "timesofisrael.com", type: "site" },
      { name: "Israel Hayom", host: "israelhayom.co.il", type: "site" },
      { name: "i24NEWS", host: "i24news.tv", type: "site" }
    ];

    // State
    const $ = (s, el=document) => el.querySelector(s);
    const create = (t, props={}) => Object.assign(document.createElement(t), props);
    const historyKey = "newsagg.history.v2";
    const selectedSourcesKey = "newsagg.sources.v2";
    let selectedHosts = new Set(JSON.parse(localStorage.getItem(selectedSourcesKey) || "null") || SOURCES.map(s => s.host));

    function saveSelected(){ localStorage.setItem(selectedSourcesKey, JSON.stringify([...selectedHosts])); }
    function addHistory(q){
      const arr = JSON.parse(localStorage.getItem(historyKey) || "[]");
      if (!arr.includes(q)) arr.unshift(q);
      localStorage.setItem(historyKey, JSON.stringify(arr.slice(0, 30)));
      renderHistory();
    }

    function renderHistory(){
      const box = $("#history");
      const arr = JSON.parse(localStorage.getItem(historyKey) || "[]");
      box.innerHTML = "";
      arr.forEach(q => {
        const row = create("div", { className: "hist-item" });
        const a = create("a", { href: "#", textContent: q });
        a.onclick = (e) => { e.preventDefault(); $("#q").value = q; run(q); };
        const del = create("button", { textContent: "מחק" });
        del.onclick = ()=>{
          const now = JSON.parse(localStorage.getItem(historyKey) || "[]").filter(x => x !== q);
          localStorage.setItem(historyKey, JSON.stringify(now)); renderHistory();
        };
        row.append(a, del); box.appendChild(row);
      });
    }

    function renderSources(){
      const wrap = $("#sources");
      wrap.innerHTML = "";
      SOURCES.forEach(s => {
        const id = "src-" + s.host.replace(/\W/g,"");
        const lab = create("label");
        const cb = create("input", { type: "checkbox", id, checked: selectedHosts.has(s.host)});
        cb.onchange = ()=>{ if(cb.checked) selectedHosts.add(s.host); else selectedHosts.delete(s.host); saveSelected(); };
        lab.append(cb, document.createTextNode(" " + (s.name || s.host)));
        wrap.appendChild(lab); wrap.appendChild(document.createElement("br"));
      });
      // chips row
      const chips = $("#chips"); chips.innerHTML = "";
      SOURCES.forEach(s => {
        const el = create("span", { className: "chip" });
        el.textContent = s.name;
        chips.appendChild(el);
      });
    }

    function buildSearchUrl(source, q){
      const encoded = encodeURIComponent(q);
      if (source.type === "search" && source.host === "news.google.com") {
        return `https://news.google.com/search?q=${encoded}&hl=he-IL&gl=IL&ceid=IL:he`;
      }
      return `https://www.bing.com/search?q=site%3A${encodeURIComponent(source.host)}+${encoded}`;
    }

    async function fetchThroughReader(url){
      const reader = "https://r.jina.ai/http/";
      const u = url.startsWith("http") ? url : ("https://" + url);
      const final = reader + u.replace(/^https?:\/\//,"");
      const res = await fetch(final, { mode: "cors" });
      if (!res.ok) throw new Error("Fetch failed: " + res.status);
      return await res.text();
    }

    function parseBingLinks(html, host){
      const out = [];
      const rx = /<li class=\"b_algo\">[\s\S]*?<h2><a href=\"([^\"]+)\"[^>]*>([\s\S]*?)<\/a><\/h2>[\s\S]*?(?:<p>([\s\S]*?)<\/p>)?/g;
      let m;
      while ((m = rx.exec(html))) {
        const href = m[1]; if (!href || !href.includes(host)) continue;
        const title = (m[2]||"").replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim();
        const snippet = (m[3]||"").replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim();
        out.push({ href, title, snippet, host });
      }
      return out;
    }

    function renderResults(items){
      const grid = $("#results"); grid.innerHTML = "";
      $("#count").textContent = items.length ? (items.length + " תוצאות") : "";
      items.forEach(it => {
        const card = create("article", { className: "card" });
        const h3 = create("h3"); h3.textContent = it.title || it.href;
        const meta = create("div", { className: "meta" }); meta.textContent = it.host;
        const p = create("p"); p.textContent = it.snippet || "";
        const open = create("a", { href: it.href, target: "_blank", rel: "noopener", textContent: "פתח מקור" });
        // Modal preview
        card.onclick = (e)=>{
          if (e.target.tagName.toLowerCase() === 'a') return;
          $("#m-title").textContent = it.title || "";
          $("#m-meta").textContent = it.host;
          $("#m-snippet").textContent = it.snippet || "";
          $("#m-link").href = it.href;
          $("#modal").classList.add("open");
        };
        card.append(h3, meta, p, open);
        grid.appendChild(card);
      });
    }

    function sortItems(items, how){
      if (how === "source") items.sort((a,b)=> a.host.localeCompare(b.host));
      if (how === "title") items.sort((a,b)=> (a.title||"").localeCompare(b.title||""));
      return items;
    }

    async function run(q){
      $("#count").textContent = "מחפש…";
      const all = [];
      const active = SOURCES.filter(s => selectedHosts.has(s.host));
      for (const src of active) {
        try {
          const url = buildSearchUrl(src, q);
          if (src.host === "news.google.com") {
            all.push({ href: url, title: "תוצאות ב-Google News: " + q, snippet: "פתח להצגת סיקור רחב", host: src.host });
            continue;
          }
          const html = await fetchThroughReader(url);
          const items = parseBingLinks(html, src.host);
          all.push(...items.slice(0, 6));
        } catch (e) {
          all.push({ href: buildSearchUrl(src, q), title: `[${src.name}] פתיחת תוצאות (חסימה)`, snippet: String(e.message||e), host: src.host });
        }
      }
      // dedupe
      const seen = new Set(), uniq = [];
      for (const it of all) if (!seen.has(it.href)) { seen.add(it.href); uniq.push(it); }
      const how = $("#sort").value;
      renderResults(sortItems(uniq, how));
      addHistory(q);
      if (location) history.replaceState(null, "", "#q=" + encodeURIComponent(q));
    }

    // UI wiring
    renderSources(); renderHistory();
    const input = $("#q"); const btn = $("#go");
    btn.onclick = ()=>{ const q = input.value.trim(); if(q) run(q); };
    input.addEventListener("keydown", e=>{ if(e.key === "Enter"){ const q = input.value.trim(); if(q) run(q);} });
    $("#clear").onclick = ()=>{ localStorage.removeItem(historyKey); renderHistory(); };
    $("#share").onclick = (e)=>{
      e.preventDefault();
      const url = location.href;
      if (navigator.share) navigator.share({ title: document.title, url });
      else navigator.clipboard.writeText(url);
      alert("הקישור הועתק/שותף");
    };
    $("#sort").onchange = ()=>{
      const cards = []; // re-render with sort using last query if exists
      const hash = location.hash.startsWith("#q=") ? decodeURIComponent(location.hash.slice(3)) : "";
      if (hash) run(hash);
    };
    $("#toggle").onclick = ()=>{ $("#aside").classList.toggle("open"); };

    // Deep link
    if (location.hash.startsWith("#q=")) {
      const q = decodeURIComponent(location.hash.slice(3));
      input.value = q; run(q);
    }

    // iOS safe area
    document.body.style.paddingBottom = "env(safe-area-inset-bottom)";
  </script>
</body>
</html>
